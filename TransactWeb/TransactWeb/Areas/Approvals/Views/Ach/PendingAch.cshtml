@model IList<TransferAuthorizationWeb.Areas.Approvals.Models.PendingAchApprovals>

<script type="text/javascript">


    function getAchData() {

        var ach = {};

        ach.Name = $('#Name').val();
        ach.AccountNumber = $('#AccountNumber').val();
        ach.Amount = $('#Amount').val();
        ach.Notes = $('#Notes').val();
        //    ach.OriginatingSystem = $('#OriginatingSystem').val();

        return ach;
    }


    function SubmitAch() {

        var data = getAchData();

        $.ajax({
            type: "POST",
            data: data,
            //async: true,
            url: '@Url.Action("AddAchTransfer")',

            success: function (resp) {


            },

            error: function (e) {


            }
        });

    }
   
    $(document).ready(function () {
        









        intitializeAuthorizationTabs();
        initalizePendingAchGrid();
        initalizeAchAuthorizationHistoryGrid();
        installEventListeners();
    });

    function installEventListeners() {
        

        $('#Test').click(function () {

            alert('hello');
            SubmitAch();
        });

        $('#AuthorizeSelectedAchs').click(function () {

            AuthorizeSelectedItems();
        });

        $('#MultipleSelect').click(function () {

            ToggleSelectAll('MultipleSelect');
        });


        $('#RefreshItems').click(function () {
            var grid = $("#pendingAchGrid").data("kendoGrid");
         
            grid.refresh();           
        });
    }
    

    function UpdateAchMenuCount() {

        var rowCount = $('#pendingAchGrid tr').length;

        if (rowCount == 0) {

            $('#wrapper').hide();
            $("#AchCount").text("");
            $('#NoRowsFoundTemplate').show();
        }
        else {

            $("#AchCount").text("(" + rowCount + ")");
        }
    }



    function intitializeAuthorizationTabs() {

        $("#approvalTabs").kendoTabStrip({
            animation: {

                open: {
                    effects: "fadeIn"
                }
            }
        });
    }

    function initalizePendingAchGrid() {

        var dataSource = new kendo.data.DataSource({

            transport:{
                read:
                    {
                        type: 'post',
                        dataType: 'json',
                        url: '@Url.Action("GetPendingAchApprovals", "Ach", new RouteValueDictionary(new { id = "1" }))'
                    }
            },
            schema: {

                model: {

                    fields: {
                        Id:             { type: 'number'},
                        Amount:         { type: 'number' },
                        CheckNumber:    { type: 'string' },
                        CheckSignerId:  { type: 'string' },
                        Payee1:         { type: 'string' },
                        Payee2:         { type: 'string' },
                        Payee3:         { type: 'string' }
                    }
                }
            }
        });

        $('#pendingAchGrid').kendoGrid({

            dataSource: dataSource,

            columns: [
                {template: '<input type="checkbox" id = "#= Id #"/>', width: '30px' },
                {field: 'Amount', width:100, template: '<div style="text-align:right">#= kendo.toString(Amount, "c")#</div>' },
                {field: 'CheckNumber', width:200, template: '<div style="text-align:right">#= CheckNumber #</div>' },
                {field: 'CheckSignerId'},
                {field: 'Payee1'},
                {field: 'Payee2'},
                {field: 'Payee3'}
            ],
            height:275,
            selectable: true
        });
    }


    function initalizeAchAuthorizationHistoryGrid() {

        var dataSource = new kendo.data.DataSource({

            transport: {
                
                read:{
                    type: 'post',
                    dataType: 'json',
                    url: '@Url.Action("GetAchApprovalHistory","Ach",new RouteValueDictionary(new { id = "1" }))'
                }
            },
            schema: {

                model: {

                    fields:{
                        ApprovalDate: { type: 'string' },
                        Amount: { type: 'number' },
                        CheckNumber: { type: 'string' },
                        CheckSignerId: { type: 'string' }
                    }
                }
            }
        });


        $('#AchApprovalHistoryGrid').kendoGrid({

            dataSource: dataSource,

            columns: [
                {field: 'ApprovalDate', title: 'Approval Date/Time'},
                {field: 'Amount', title: 'Amount' },
                {field: 'CheckNumber', title: 'Check Number'},
                {field: 'CheckSignerId', title: 'Check Signer'}
            ],

            height: 200,
            selectable: true
        
        }); 
    }


    function AuthorizeSelectedItems() {

        var approvalHub = $.connection.approvalHub;

        approvalHub.authorized($('#msg').val());
     
        var errorsFound = false;

        var atLeastOneIsChecked = $(':checkbox:checked').length > 0;

        if (atLeastOneIsChecked) {

            if (confirm("Authorize Selected Item(s)?", "Approve")) {

                $('#pendingAchGrid tr').each(function () {

                    var currentRow = $(this);
                    var currentCheckBox = $(this).find('input:checkbox');
                   
                    if (currentCheckBox.attr("checked") == "checked") {

                        $.ajax({
                            type: "POST",
                            url: '@Url.Action("ApproveAch")',
                            data: currentCheckBox.attr('id'),
                            success: function (resp) {

                                currentRow.remove();
                                UpdateAchMenuCount();
                            },

                            error: function (e) {

                                alert('errorsFound');
                                errorsFound = true;
                            }
                        });
                    }
                });
            }
        }
        else {

            alert('No Items Selected To Authorize');
        }
    }
    

    function removeAllItems() {

        $('#pendingAchGrid tr').each(function () {

            var currentRow = $(this);
            
            currentRow.remove(); 
        });
    }

</script>

<div id="RootApprovalTabs" class="ApprovalTabs">
    
     <table>
    <tr>
        <td>Name</td>
        <td>
            <input type="text" id ="Name"/>
        </td>
    </tr>
    
    <tr>
        <td>Account Number</td>
        <td>
            <input type="text" id ="AccountNumber"/>
        </td>

    </tr>
    
    <tr>
        <td>Amount</td>
        <td>
            <input type="text" id ="Amount"/>
        </td>

    </tr>
        
    <tr>
        <td>Notes</td>
        <td>
            <input type="text" id ="Notes"/>
        </td>

    </tr>
    
    
    <tr>
        <td>
            <button id="Test" type="submit" onclick="SubmitAch();">Submit</button>
           
        </td>

    </tr>
        
    

   
    
</table>
   
    
    <div id="approvalTabs">
        <ul>
            <li class="k-state-active">Pending Ach's</li>
            <li>Authorization History</li>
        </ul>

        <div id="PendingApprovalsTab" style="background-color:#fef8f0;padding-left:0px;padding-right:0px;padding-top:0px;padding-bottom:0px">
            
            <div id="wrapper" style="height:380px;background-color:#fef8f0;padding-left:5px;padding-right:5px;padding-top:5px;padding-bottom:0px">
                
                <table id="pendingAchGrid">
                    <thead>
                        <tr>
                            <th style="width: 30px"><input title="selects all items" id="MultipleSelect" type="checkbox"/></th>
                            <th data-field="Amount">Amount</th>
                            <th data-field="CheckNumber">Check Number</th>
                            <th data-field="CheckSignerId">Check Signer</th>
                            <th data-field="Payee1">Payee 1</th>
                            <th data-field="Payee2">Payee 2</th>
                            <th data-field="Payee3">Payee 3</th>
                        </tr>
                    </thead>
                </table>
                
                <div style="height:40px"/></div>
            
            
            
            <div>
                <script type="text/javascript">
                    $(function () {

                        // Proxy created on the fly
                        var approvalHub = $.connection.approvalHub;

                        // Declare a function on the chat hub so the server can invoke it
                        approvalHub.addMessage = function (message) {

                            removeAllItems();
                        };

                        // Start the connection
                        $.connection.hub.start();
                    });
                </script>
                <input type="text" id="msg" />
                <input type="button" id="broadcast" />
                <ul id="messages"></ul>
            </div>
                
            <table>
                <tr>
                    <td>
                        <div class="k-content" style="padding-top:15px;padding-left: 0px;padding-bottom:15px;background-color: #fef8f0;border-color: #fef8f0">
                            <button id="AuthorizeSelectedAchs" title="approves all selected item(s)" style="padding-left:8px;padding-right:9px;background-color:#4aa3b5;color:white" class="k-button">Authorize Item(s)</button>
                        </div>
                    </td>
                    <td>
                        <div class="k-content" style="padding-top:15px;padding-left: 0px;padding-bottom:15px;background-color: #fef8f0;border-color: #fef8f0">
                            <button id="RefreshItems" title="refresh pending Ach's" style="padding-left:8px;padding-right:9px;background-color:#7c6a55;color:white" class="k-button">Refresh</button>
                        </div>
                    </td>
                </tr>
            </table>
                
        </div>
              
        <div id="NoRowsFoundTemplate" style="display:none;height:373px;text-align:center;">
            <p>The Are No Items To Authorize</p>
        </div>
    </div>

    <div id="AchApprovalHistoryTab" style="background-color:#fef8f0;padding-left: 0px;padding-right:0px;padding-top: 0px;padding-bottom: 0px">
            
        <div id="wrapper2" style="height:380px;background-color:#fef8f0;padding-left:5px;padding-right:5px;padding-top:5px;padding-bottom:0px">

            <table id="AchApprovalHistoryGrid">
                <thead>
                    <tr>
                        <th data-field="Payee1">Approval Date/Time</th>
                        <th data-field="Amount">Amount</th>
                        <th data-field="CheckNumber">Check Number</th>
                        <th data-field="CheckSignerId">Check Signer</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>
    

</div>











